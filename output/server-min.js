const app=require("express")(),express=require("express"),http=require("http").Server(app),io=require("socket.io")(http),port=3333,blackjack=require("./blackjack-min");process.on("uncaughtException",function(e){console.error("uncaughtException",e.stack)});let game={player:[],dealer:{},deck:[],active:!1,winnerList:[]},activePlayers=[];blackjack.createDeck(game),blackjack.shuffleDeck(game),blackjack.createDealer(game),http.listen(3333,function(){console.log("listening on *: 3333")}),app.get("/",function(e,a){a.sendFile(__dirname+"/index.html")}),app.use(express.static(__dirname));let userList={users:[]};io.on("connection",function(e){function a(e){io.emit("userList",e)}function t(e){if(e.dealer.active)var a={player:e.player,dealer:e.dealer};else a={player:e.player,dealer:{name:"dealer",hand:[e.dealer.hand[0],{unicode:"<span class='cardBack'>ðŸ‚ </span>",png:"/png/blue_back.png"}],score:e.dealer.score}};io.emit("showHand",a)}function n(){io.emit("disable")}function r(){n();let a=e.userName;for(let e=0;e<game.player.length;e++)if(game.player[e].name===a){game.player[e].active=!1;break}let r=c(game);null==r?(game.dealer.active=!0,blackjack.stand(game,activePlayers.length),t(game),io.emit("enable newGame"),function(e){io.emit("won",e)}(game),function(e){for(let a=0;a<e.player.length;a++)e.player[a].hand=[],e.player[a].score=0,e.player[a].surended=!1;e.dealer.active=!1,e.dealer.hand=[],e.dealer.score=0,e.winnerList=[]}(game),game.active=!1,i(game)):io.to(`${r.socketid}`).emit("enable")}function i(e){for(let a=0;a<e.player.length;a++)io.to(`${e.player[a].socketid}`).emit("updateBalance",e.player[a].balance)}function s(a,t){return a.player.find(function(a){return a.name==e.userName})}function c(e){return e.player.find(function(e){return e.active})}a(userList),e.on("change_username",function(n){-1===userList.users.indexOf(n.username)?(userName=n.username,e.userName=n.username,userList.users.push(userName),a(userList),io.emit("chat message",userName+" connected"),console.log(userName+" connected"),blackjack.createPlayer(game,100,e.id,userName,1e3,!1),i(game),game.active&&t(game)):(e.emit("user already exist"),e.disconnect(!0))}),e.on("typing",function(){e.broadcast.emit("typing",{username:e.userName})}),e.on("done typing",function(){e.broadcast.emit("done typing",{username:e.userName})}),e.on("disconnect",function(){let t=userList.users.indexOf(e.userName);t>-1&&userList.users.splice(t,1),a(userList),console.log(e.userName+" user disconnected")}),e.on("chat message",a=>{let t=new Date,n=t.getHours(),r=t.getMinutes();r<10&&(r="0"+r),io.emit("chat message",n+":"+r+" "+e.userName+": "+a)}),e.on("newGame",()=>{if(!1===game.active&&activePlayers.length>0){for(let e=0;e<game.player.length;e++)game.player[e].active=!1;i(game);for(let e=0;e<game.player.length;e++)for(let a=0;a<activePlayers.length;a++)game.player[e].name===activePlayers[a]&&(game.player[e].id=a,game.player[e].active=!0);let e=c(game);game.active=!0,game.dealer.activ=!1,blackjack.deal(game),n(),function(e){io.to(`${e}`).emit("enable")}(e.socketid),t(game)}}),e.on("active",()=>{activePlayers.length<3?activePlayers.push(e.userName):e.emit("to many active players"),console.log("Active players: "+activePlayers)}),e.on("not active",()=>{let a=activePlayers.indexOf(e.userName);activePlayers.splice(a,1),console.log("Active players: "+activePlayers)}),e.on("hit",function(a){blackjack.hit(game,e.userName),t(game),s(game,e.userName).score>21&&r()}),e.on("stand",function(e){r()}),e.on("bet",function(a){let t=s(game,e.userName);t.bet+=parseInt(a),t.balance>=a&&(t.balance-=a,i(game))}),e.on("doubleDown",function(a){let n=s(game,e.userName);n.balance>=n.bet&&(n.balance-=n.bet,n.bet=2*n.bet,blackjack.hit(game,e.userName),t(game),r())}),e.on("surrender",function(a){let t=s(game,e.userName);t.bet=.5*t.bet,t.balance+=t.bet,t.bet=0,t.active=!1,t.surended=!0,r()}),e.on("reset",function(){n(),io.emit("enable newGame"),game.player=[],game.active=!1,game.winnerList=[],activePlayers=[]})});